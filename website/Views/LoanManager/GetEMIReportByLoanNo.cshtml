@model website.Dto.LoanCardDetails

@{
    ViewBag.Title = "GetEMIReportByLoanNo";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Content/plugins/datatables/dataTables.bootstrap.css" rel="stylesheet" type="text/css" />
<link href="~/Content/dist/css/AdminLTE.min.css" rel="stylesheet" type="text/css" />
<link href="~/Content/dist/css/skins/_all-skins.min.css" rel="stylesheet" type="text/css" />


<section class="content-header">
    <h1>
        Customer Loan Details
    </h1>
</section>


<section class="content">
    <div class="row">
        <div class="col-md-4">
            <div class="box box-primary">
                <div class="box-body box-profile">
                    <img class="profile-user-img img-responsive img-circle" src="~/Documentation/Profiles/@Model.CustomerCardInfo.CustomerProfile" alt="User profile picture">
                    <h3 class="profile-username text-center">@Model.CustomerCardInfo.CustomerName</h3>
                    <ul class="list-group list-group-unbordered">
                        <li class="list-group-item">
                            <b>Branch Name</b> <a class="pull-right">@Model.CustomerCardInfo.BranchName</a>
                        </li>
                        <li class="list-group-item">
                            <b>Account No</b> <a class="pull-right">@Model.CustomerCardInfo.LoanAccNo</a>
                        </li>
                        <li class="list-group-item">
                            <b>Loan No</b> <a class="pull-right">@Model.CustomerCardInfo.LoanNo</a>
                        </li>
                        <li class="list-group-item">
                            <b>Section Amount</b> <a class="pull-right">@Model.CustomerCardInfo.SectionAmount</a>
                        </li>
                        <li class="list-group-item">
                            <b>Loan with Intrest</b> <a class="pull-right">@Model.CustomerCardInfo.LoanNetAmount</a>
                        </li>
                        <li class="list-group-item">
                            <b>Received Amount</b> <a class="pull-right">@Model.CustomerCardInfo.ReceivedAmount</a>
                        </li>
                        <li class="list-group-item">
                            <b>No Of Days</b> <a class="pull-right">@Model.CustomerCardInfo.NoOfDays</a>
                        </li>
                        <li class="list-group-item">
                            <b>Loan Date</b> <a class="pull-right">@(Model.CustomerCardInfo.LoanDate.Value.ToString("dd-MM-yyyy"))</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="box box-primary">
                <table class="table table-bordered table-striped" id="loanDetails">
                    <tr>
                        <th>
                            Date
                        </th>
                        <th>
                            Inst Amount
                        </th>
                        <th>
                            Amount
                        </th>
                        <th>
                            Paider Name
                        </th>
                        <th>
                            Amount Collected
                        </th>
                        <th>Action</th>
                    </tr>

                    @foreach (var item in Model.LoanCardEMIs)
                    {
                        <tr>
                            <td>
                                @Html.DisplayFor(modelItem => item.RepaymentDate)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Inst_Amount)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.OS_pricipal)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.PaiderName)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.AmountCollected)
                            </td>
                            <td>
                                @{
                                    if (item.PaidStatus == true)
                                    {
                                        <button id="btnApproved" class="btn btn-default" onclick="GetPaymentDetails(@item.Id)"><img src="~/Content/Images/approved.png" style="width:30px;" /></button>
                                    }
                                    else
                                    {
                                        if (item.RepaymentDate.Value.Day <= DateTime.Now.Day && item.RepaymentDate.Value.Month <= DateTime.Now.Month)
                                        {
                                            <button class="btn btn-sm btn-danger" id="btnSubmit" onclick="GetPayment(@item.Id)">Payment</button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-danger" disabled="disabled">Payment</button>

                                        }
                                    }
                                }
                            </td>
                        </tr>
                    }

                </table>
            </div>
        </div>
    </div>

</section>
<div class="modal fade" id="PaymentModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
</div>

@section Scripts
{
    <script src="~/Content/plugins/datatables/jquery.dataTables.js" type="text/javascript"></script>
    <script src="~/Content/plugins/datatables/dataTables.bootstrap.js" type="text/javascript"></script>
    <!-- SlimScroll -->
    <script src="~/Content/plugins/slimScroll/jquery.slimscroll.min.js" type="text/javascript"></script>
    <!-- FastClick -->
    <script src='~/Content/plugins/fastclick/fastclick.min.js'></script>
    <!-- AdminLTE App -->
    <script src="~/Content/dist/js/app.min.js" type="text/javascript"></script>
    <!-- AdminLTE for demo purposes -->
    <script src="~/Content/dist/js/demo.js" type="text/javascript"></script>

    <script type="text/javascript">
        //$(function () {
        //    $("#loanDetails").dataTable();
        //});

        $(document).ready(function () {
            $("#PaymentModal").on("click", "#btnSubmit", function ()
            {
                debugger;
                var id = $("#Id").val();
                var repaymentDate = $("#RepaymentDate").val();
                var loanNo = $("#loanNo").val();
                var paiderName = $("#paiderName").val();
                var paymentType = $("#paymentType").val();
                var amount = $("#amount").val();

                if (parseInt(paymentType) != 0) {
                    var loanData = {};
                    loanData.id = id;
                    loanData.repaymentDate = repaymentDate;
                    loanData.loanNo = loanNo;
                    loanData.paiderName = paiderName;
                    loanData.paidBy = paymentType;
                    loanData.amountCollected = amount;

                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("SubmitCustomPayment", "CustomerEMIs")',
                        data: { loanData: loanData },
                        success: function (data) {
                            alert(data);
                            window.location.reload();
                        },
                        error: function () {
                            alert('Error occurred while saving data.');
                        }
                    });
                } else {
                    alert('Please select payment type.');
                }

            });
        });

        function GetPayment(id)
        {
            $.ajax({
                url: "@(website.Helpers.APIPath.Api_Path)CustomerEMIs/OtherWayForPayment?id=" + id,
                type: "get",
                dataType: "html",
                success: function (response) {
                            //$("#PaymentModal").empty();
                            $("#PaymentModal").html(response);
                            $("#PaymentModal").modal("show");

                },
                error: function (xhr) {
                    console.error("Error occurred during AJAX call:", xhr);
                }
            });
        }

        function GetPaymentDetails(id) {
            $.ajax({
                url: "@(website.Helpers.APIPath.Api_Path)CustomerEMIs/OtherWayForPayment?id=" + id,
                type: "get",
                dataType: "html",
                success: function (response) {
                            //$("#PaymentModal").empty();
                            $("#PaymentModal").html(response);
                            $("#PaymentModal").modal("show");
                            $("#PaymentModal #btnSubmit").attr("style", "display:none;")
                            $("#PaymentModal #txtTitle").text("Payment Details");

                            $("#PaymentModal #RepaymentDate").prop("disabled","disabled");
                            $("#PaymentModal #paiderName").prop("disabled", "disabled");
                            $("#PaymentModal #paymentType").prop("disabled", "disabled");
                            $("#PaymentModal #amount").prop("disabled", "disabled");


                },
                error: function (xhr) {
                    console.error("Error occurred during AJAX call:", xhr);
                }
            });
        }
    </script>
}